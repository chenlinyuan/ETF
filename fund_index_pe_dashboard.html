<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²ªæ·±300åŸºé‡‘&æŒ‡æ•°&PEä»ªè¡¨æ¿</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: hsl(0, 0%, 20%);
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        #fundChart, #indexChart, #peChart {
            width: 100%;
            height: 400px;
        }
        #backtestResults {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .result-item {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .result-label {
            font-size: 14px;
            color: #666;
        }
        .result-value {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        .positive {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .negative {
            background-color: #ffebee;
            color: #c62828;
        }
        button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1565c0;
        }
        button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        #loadingIndicator {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ»‘æ†æ ·å¼ */
        input[type="range"] {
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1976d2;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1976d2;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            background: #ddd;
            height: 6px;
            border-radius: 3px;
        }
        
        input[type="range"]::-moz-range-track {
            background: #ddd;
            height: 6px;
            border-radius: 3px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ²ªæ·±300åŸºé‡‘&æŒ‡æ•°&PEä»ªè¡¨æ¿</h1>
        
        <!-- æ·»åŠ PEé˜ˆå€¼è®¾ç½®è¾“å…¥æ¡† -->
        <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;">
            <h2 style="margin-top: 0; color: #333;">ç­–ç•¥å‚æ•°è®¾ç½®</h2>
            <div style="margin-bottom: 15px;">
                <label for="dataTypeSelector" style="display: block; margin-bottom: 10px; font-weight: bold;">é€‰æ‹©æ•°æ®ç±»å‹ï¼š</label>
                <select id="dataTypeSelector" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; font-size: 14px;" onchange="changeDataType()">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div id="dataRangeInfo" style="padding: 10px; background-color: #e3f2fd; border-left: 4px solid #1976d2; margin-bottom: 15px; border-radius: 4px; color: #1565c0;">
                <strong>ğŸ“Š æ•°æ®èŒƒå›´ä¿¡æ¯ï¼š</strong><br>
                <span id="dataRangeText">æ­£åœ¨åŠ è½½æ•°æ®...</span>
            </div>
            <div style="display: flex; gap: 30px; flex-wrap: wrap; align-items: flex-start;">
                <div style="flex: 1; min-width: 250px;">
                    <label for="buyThreshold" style="display: block; margin-bottom: 10px; font-weight: bold;">
                        ä¹°å…¥PEåˆ†ä½ç‚¹é˜ˆå€¼: <span id="buyThresholdValue" style="color: #2ca02c; font-size: 18px;">40</span>%
                    </label>
                    <input type="range" id="buyThreshold" min="0" max="100" step="1" value="40" 
                           style="width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; cursor: pointer;"
                           oninput="updateBuyThresholdDisplay()">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #999; margin-top: 5px;">
                        <span>0%</span>
                        <span>50%</span>
                        <span>100%</span>
                    </div>
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <label for="sellThreshold" style="display: block; margin-bottom: 10px; font-weight: bold;">
                        å–å‡ºPEåˆ†ä½ç‚¹é˜ˆå€¼: <span id="sellThresholdValue" style="color: #d62728; font-size: 18px;">60</span>%
                    </label>
                    <input type="range" id="sellThreshold" min="0" max="100" step="1" value="60" 
                           style="width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; cursor: pointer;"
                           oninput="updateSellThresholdDisplay()">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #999; margin-top: 5px;">
                        <span>0%</span>
                        <span>50%</span>
                        <span>100%</span>
                    </div>
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <label for="endDatePicker" style="display: block; margin-bottom: 10px; font-weight: bold;">å›æµ‹ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" id="endDatePicker" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%;">
                </div>
            </div>
        </div>
        
        <div id="backtestResults">
            <h2>å›æµ‹ç»“æœ</h2>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">èµ·å§‹æ—¥æœŸ</div>
                    <div class="result-value" id="startDate">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">ç»“æŸæ—¥æœŸ</div>
                    <div class="result-value" id="endDate">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">åŸºé‡‘æ”¶ç›Šç‡</div>
                    <div class="result-value" id="fundReturn">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">æŒ‡æ•°æ”¶ç›Šç‡</div>
                    <div class="result-value" id="indexReturn">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">è¶…é¢æ”¶ç›Š</div>
                    <div class="result-value" id="excessReturn">-</div>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="hideBacktestResults()">å…³é—­ç»“æœ</button>
                <button onclick="showTradeDetails()" style="margin-left: 10px;">æŸ¥çœ‹æŠ•èµ„è¯¦æƒ…</button>
            </div>
        </div>
        
        <!-- æŠ•èµ„è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="tradeDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000;">
            <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">æŠ•èµ„è¯¦æƒ…</h2>
                    <button onclick="closeTradeDetails()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Ã—</button>
                </div>
                <div id="tradeDetailsContent"></div>
            </div>
        </div>
        
        <div id="loadingIndicator">
            <div class="spinner"></div>
            <p>æ­£åœ¨è¿›è¡Œå›æµ‹...</p>
        </div>
        
        <div class="chart-container">
            <div class="chart-title" id="chartTitle">åŠ è½½ä¸­...</div>
            <div id="fundChart"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let availableDataTypes = [];
        let currentDataType = 'æ²ªæ·±300';
        let fundData = [];
        let peData = [];
        let mergedData = [];
        
        // å›¾è¡¨å®ä¾‹
        let fundChart = null;
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeDataTypeSelector();
            await loadData();
            initializeDatePicker();
            createCharts();
            updateBuyThresholdDisplay();
            updateSellThresholdDisplay();
        });
        
        // æ›´æ–°ä¹°å…¥é˜ˆå€¼æ˜¾ç¤º
        function updateBuyThresholdDisplay() {
            const value = document.getElementById('buyThreshold').value;
            document.getElementById('buyThresholdValue').textContent = value;
        }
        
        // æ›´æ–°å–å‡ºé˜ˆå€¼æ˜¾ç¤º
        function updateSellThresholdDisplay() {
            const value = document.getElementById('sellThreshold').value;
            document.getElementById('sellThresholdValue').textContent = value;
        }
        
        // è·å–æ‰€æœ‰å¯ç”¨çš„æ•°æ®ç±»å‹æ–‡ä»¶å¤¹
        async function loadAvailableDataTypes() {
            try {
                const knownTypes = ['æ²ªæ·±300', 'ç™½é…’'];
                const availableTypes = [];
                
                for (const type of knownTypes) {
                    try {
                        const response = await fetch(`ETFData/${type}/price.csv`);
                        if (response.ok) {
                            availableTypes.push(type);
                        }
                    } catch (e) {
                        // æ–‡ä»¶ä¸å­˜åœ¨
                    }
                }
                
                if (availableTypes.length === 0) {
                    availableTypes.push('æ²ªæ·±300');
                }
                
                return availableTypes;
            } catch (e) {
                console.error('åŠ è½½æ•°æ®ç±»å‹å¤±è´¥:', e);
                return ['æ²ªæ·±300'];
            }
        }
        
        // åˆå§‹åŒ–æ•°æ®ç±»å‹é€‰æ‹©å™¨
        async function initializeDataTypeSelector() {
            availableDataTypes = await loadAvailableDataTypes();
            const selector = document.getElementById('dataTypeSelector');
            selector.innerHTML = '';
            
            availableDataTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                if (type === 'æ²ªæ·±300') {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            currentDataType = 'æ²ªæ·±300';
        }
        
        // åˆ‡æ¢æ•°æ®ç±»å‹
        async function changeDataType() {
            const selector = document.getElementById('dataTypeSelector');
            currentDataType = selector.value;
            await loadData();
            createCharts();
            initializeDatePicker();
        }
        
        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        function initializeDatePicker() {
            const datePicker = document.getElementById('endDatePicker');
            // è®¾ç½®é»˜è®¤ç»“æŸæ—¥æœŸä¸ºåˆå¹¶æ•°æ®é›†çš„æœ€åä¸€å¤©
            if (mergedData && mergedData.length > 0) {
                const lastDate = mergedData[mergedData.length - 1].date;
                const firstDate = mergedData[0].date;
                datePicker.min = firstDate;
                datePicker.max = lastDate;
                datePicker.value = lastDate;
            }
        }
        
        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // æ ¹æ®å½“å‰é€‰æ‹©çš„æ•°æ®ç±»å‹åŠ è½½æ•°æ®
                let fundFilePath, peFilePath;
                
                // ç»Ÿä¸€ä½¿ç”¨æ–°çš„ç›®å½•ç»“æ„
                fundFilePath = `ETFData/${currentDataType}/price.csv`;
                peFilePath = `ETFData/${currentDataType}/pe.csv`;
                
                // ä»CSVæ–‡ä»¶åŠ è½½åŸºé‡‘æ•°æ®
                const responseFund = await fetch(fundFilePath);
                const textFund = await responseFund.text();
                const linesFund = textFund.split('\n').filter(line => line.trim() !== '');
                
                fundData = linesFund.slice(1).map(line => {
                    const parts = line.split(',');
                    if (parts.length >= 2 && parts[0].trim()) {
                        const date = parts[0].trim();
                        const value = parseFloat(parts[1].trim().replace('=', ''));
                        if (!isNaN(value)) {
                            return { date, close: value };
                        }
                    }
                    return null;
                }).filter(item => item);
                
                // ä»CSVæ–‡ä»¶åŠ è½½PEæ•°æ®
                const responsePe = await fetch(peFilePath);
                const textPe = await responsePe.text();
                const linesPe = textPe.split('\n').filter(line => line.trim() !== '');
                const headersPe = linesPe[0].split(',').map(h => h.trim());
                
                peData = linesPe.slice(1).map(line => {
                    const parts = line.split(',');
                    if (parts.length >= headersPe.length) {
                        const dateIndex = headersPe.findIndex(h => h.includes('æ—¥æœŸ'));
                        const peIndex = headersPe.findIndex(h => h.includes('PE'));
                        
                        if (dateIndex >= 0 && peIndex >= 0) {
                            const date = parts[dateIndex].trim();
                            const pe = parseFloat(parts[peIndex].trim().replace('=', ''));
                            
                            if (!isNaN(pe)) {
                                return { date, pe };
                            }
                        }
                    }
                    return null;
                }).filter(item => item);
                
                // è®¡ç®—æ¯æ¡PEè®°å½•çš„çœŸå®åˆ†ä½ç‚¹ï¼ˆåŸºäºæ•´ä¸ªå†å²æ•°æ®ï¼‰
                if (peData.length > 0) {
                    const peValues = peData.map(d => d.pe).sort((a, b) => a - b);
                    peData.forEach(record => {
                        const lowerCount = peValues.filter(v => v <= record.pe).length;
                        record.percentile = ((lowerCount - 1) / (peValues.length - 1)) * 100;
                    });
                    const latestPE = peData[peData.length - 1];
                    console.log(`PEåˆ†ä½ç‚¹åŠ¨æ€è®¡ç®—æˆåŠŸ: ${latestPE.date} PE=${latestPE.pe.toFixed(4)} åˆ†ä½ç‚¹=${latestPE.percentile.toFixed(2)}%`);
                }
                
                // åˆå¹¶æ•°æ®ï¼šä»¥PEå’ŒåŸºé‡‘æ•°æ®ä¸ºåŸºç¡€
                mergedData = peData.map(peItem => {
                    const fundItem = fundData.find(fund => fund.date === peItem.date);
                    
                    if (fundItem) {
                        return {
                            date: peItem.date,
                            pe: peItem.pe,
                            percentile: peItem.percentile,
                            fundClose: fundItem.close
                        };
                    }
                    return null;
                }).filter(item => item && item.pe && item.fundClose);
                
                // æŒ‰æ—¥æœŸæ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
                mergedData.sort((a, b) => {
                    if (a.date < b.date) return -1;
                    if (a.date > b.date) return 1;
                    return 0;
                });
                
                console.log('æ•°æ®åŠ è½½å®Œæˆ', {
                    dataType: currentDataType,
                    fundData: fundData.length,
                    peData: peData.length,
                    mergedData: mergedData.length
                });
                
                // æ›´æ–°UIä¸­çš„æ•°æ®èŒƒå›´æ˜¾ç¤º
                if (fundData.length > 0 && peData.length > 0 && mergedData.length > 0) {
                    const fundDates = fundData.map(d => d.date).sort();
                    const peDates = peData.map(d => d.date).sort();
                    const mergedDates = mergedData.map(d => d.date).sort();
                    
                    let rangeText = `
                        <strong>âœ“ æ•°æ®ç±»å‹: ${currentDataType}</strong><br>
                        <strong>âœ“ å¯ç”¨äºå›æµ‹çš„æ—¥æœŸèŒƒå›´: ${mergedDates[0]} è‡³ ${mergedDates[mergedDates.length - 1]}</strong><br>
                        <small style="color: #666;">
                            â€¢ åŸºé‡‘æ•°æ®: ${fundDates[0]} è‡³ ${fundDates[fundDates.length - 1]}<br>
                            â€¢ PEæ•°æ®: ${peDates[0]} è‡³ ${peDates[peDates.length - 1]}
                        </small>
                    `;
                    document.getElementById('dataRangeText').innerHTML = rangeText;
                }
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åˆ›å»ºå›¾è¡¨
        function createCharts() {
            // æ£€æŸ¥æ•°æ®æ˜¯å¦å·²åŠ è½½
            if (!fundData || fundData.length === 0 || 
                !mergedData || mergedData.length === 0) {
                console.error('æ•°æ®å°šæœªåŠ è½½å®Œæˆ');
                setTimeout(createCharts, 1000);
                return;
            }
            
            // æ›´æ–°å›¾è¡¨æ ‡é¢˜
            document.getElementById('chartTitle').textContent = `${currentDataType} åŸºé‡‘å‡€å€¼ & PE-TTMä¼°å€¼ï¼ˆåŒçºµåæ ‡ï¼‰`;
            
            // åŸºé‡‘å‡€å€¼å›¾è¡¨ (çº¿å›¾ï¼Œå› ä¸ºåŸºé‡‘åªæœ‰æ”¶ç›˜ä»·)
            const fundTrace = {
                x: fundData.map(d => d.date),
                y: fundData.map(d => d.close),
                type: 'scatter',
                mode: 'lines',
                name: 'åŸºé‡‘å‡€å€¼',
                line: { color: '#1f77b4' },
                text: fundData.map(d => {
                    const mergedItem = mergedData.find(item => item.date === d.date);
                    let peInfo = '';
                    if (mergedItem && mergedItem.pe) {
                        peInfo += `<br>PE: ${mergedItem.pe.toFixed(2)}`;
                        if (mergedItem.percentile !== null) {
                            peInfo += `<br>PEåˆ†ä½ç‚¹: ${mergedItem.percentile.toFixed(2)}%`;
                        }
                    }
                    return `<b>${d.date}</b><br>å‡€å€¼: ${d.close.toFixed(4)}${peInfo}`;
                }),
                hovertemplate: '%{text}<extra></extra>'
            };
            
            // æ·»åŠ PEçº¿åˆ°åŸºé‡‘å›¾è¡¨ï¼ˆä½¿ç”¨å³ä¾§çºµåæ ‡è½´ï¼‰
            const fundPETrace = {
                x: mergedData.map(d => d.date),
                y: mergedData.map(d => d.pe),
                type: 'scatter',
                mode: 'lines',
                name: 'PE-TTM',
                line: { color: '#2ca02c', width: 2 },
                yaxis: 'y2',
                text: mergedData.map(d => 
                    `<b>${d.date}</b><br>PE-TTM: ${d.pe.toFixed(2)}<br>åˆ†ä½ç‚¹: ${d.percentile ? d.percentile.toFixed(2) : 'æ— '}%`
                ),
                hovertemplate: '%{text}<extra></extra>'
            };

            // è®¡ç®—åŸºé‡‘å›¾è¡¨çš„PEåˆ†ä½æ•°ï¼ˆç”¨äºå‚è€ƒçº¿ï¼‰
            const fundPEValues = mergedData.map(d => d.pe).filter(val => val);
            const fundPE20Percentile = calculatePercentile(fundPEValues, 20);
            const fundPE50Percentile = calculatePercentile(fundPEValues, 50);
            const fundPE80Percentile = calculatePercentile(fundPEValues, 80);
            
            const fundPE20Line = {
                x: [mergedData[0].date, mergedData[mergedData.length - 1].date],
                y: [fundPE20Percentile, fundPE20Percentile],
                mode: 'lines',
                type: 'scatter',
                name: 'PE 20%åˆ†ä½',
                line: { dash: 'dash', color: 'lightgreen', width: 1 },
                yaxis: 'y2'
            };
            
            const fundPE50Line = {
                x: [mergedData[0].date, mergedData[mergedData.length - 1].date],
                y: [fundPE50Percentile, fundPE50Percentile],
                mode: 'lines',
                type: 'scatter',
                name: 'PE 50%åˆ†ä½',
                line: { dash: 'dash', color: 'gray', width: 1 },
                yaxis: 'y2'
            };
            
            const fundPE80Line = {
                x: [mergedData[0].date, mergedData[mergedData.length - 1].date],
                y: [fundPE80Percentile, fundPE80Percentile],
                mode: 'lines',
                type: 'scatter',
                name: 'PE 80%åˆ†ä½',
                line: { dash: 'dash', color: 'orange', width: 1 },
                yaxis: 'y2'
            };

            const fundLayout = {
                title: 'æ˜“æ–¹è¾¾æ²ªæ·±300ETFè”æ¥AåŸºé‡‘å‡€å€¼ & PE-TTMä¼°å€¼ï¼ˆåŒçºµåæ ‡ï¼‰',
                xaxis: { 
                    title: 'æ—¥æœŸ',
                    showspikes: true,
                    spikemode: 'across',
                    spikesnap: 'cursor',
                    showline: true,
                    showgrid: true
                },
                yaxis: { 
                    title: 'åŸºé‡‘å‡€å€¼',
                    titlefont: { color: '#1f77b4' },
                    tickfont: { color: '#1f77b4' },
                    showspikes: true,
                    spikemode: 'across',
                    spikesnap: 'cursor',
                    showline: true,
                    showgrid: true
                },
                yaxis2: {
                    title: 'PE-TTM',
                    titlefont: { color: '#2ca02c' },
                    tickfont: { color: '#2ca02c' },
                    overlaying: 'y',
                    side: 'right'
                },
                hovermode: 'x unified',
                spikedistance: -1,
                xaxis_showspikes: true,
                yaxis_showspikes: true,
                legend: {
                    x: 0.01,
                    y: 0.99,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: 'rgba(0,0,0,0.2)',
                    borderwidth: 1
                }
            };
            
            Plotly.newPlot('fundChart', [fundTrace, fundPETrace, fundPE20Line, fundPE50Line, fundPE80Line], fundLayout);
            
            // ä¸ºåŸºé‡‘å›¾è¡¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('fundChart').on('plotly_click', function(data) {
                if (data.points && data.points.length > 0) {
                    const point = data.points[0];
                    const clickedDate = point.x; // è·å–ç‚¹å‡»çš„æ—¥æœŸ
                    
                    // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦åœ¨åˆå¹¶æ•°æ®ä¸­ï¼ˆå³æ˜¯å¦æœ‰å®Œæ•´çš„PEæ•°æ®ï¼‰
                    const mergedDateIndex = mergedData.findIndex(item => item.date === clickedDate);
                    
                    if (mergedDateIndex !== -1) {
                        // ç‚¹å‡»çš„æ—¥æœŸæœ‰å®Œæ•´æ•°æ®ï¼Œç›´æ¥è¿è¡Œå›æµ‹
                        const fundDataIndex = fundData.findIndex(item => item.date === clickedDate);
                        if (fundDataIndex !== -1) {
                            runBacktest(fundDataIndex);
                        }
                    } else {
                        // ç‚¹å‡»çš„æ—¥æœŸæ²¡æœ‰å®Œæ•´å›æµ‹æ•°æ®ï¼Œæ‰¾æœ€æ¥è¿‘çš„åç»­æ—¥æœŸ
                        const clickedTime = new Date(clickedDate).getTime();
                        const validDate = mergedData.find(item => new Date(item.date).getTime() >= clickedTime);
                        
                        // æ£€æŸ¥æ•°æ®ç¼ºå¤±çš„åŸå› 
                        const fundHas = fundData.some(d => d.date === clickedDate);
                        const indexHas = indexData.some(d => d.date === clickedDate);
                        const peHas = peData.some(d => d.date === clickedDate);
                        
                        let reasonMessage = '';
                        if (!indexHas) {
                            reasonMessage = 'ï¼ˆæ²ªæ·±300æŒ‡æ•°æ•°æ®ç¼ºå¤±ï¼‰';
                        } else if (!peHas) {
                            reasonMessage = 'ï¼ˆæ²ªæ·±300PEæ•°æ®ç¼ºå¤±ï¼‰';
                        } else {
                            reasonMessage = 'ï¼ˆæ•°æ®ä¸å®Œæ•´ï¼‰';
                        }
                        
                        if (validDate) {
                            alert(`ç‚¹å‡»æ—¥æœŸ ${clickedDate} æ— æ³•è¿›è¡Œå›æµ‹${reasonMessage}ã€‚\nå·²è‡ªåŠ¨è°ƒæ•´ä¸º ${validDate.date}ï¼ˆæœ€è¿‘çš„æœ‰æ•ˆæ—¥æœŸï¼‰ã€‚\n\nå¯ç”¨å›æµ‹èŒƒå›´: ${mergedData[0].date} è‡³ ${mergedData[mergedData.length - 1].date}`);
                            const fundDataIndex = fundData.findIndex(item => item.date === validDate.date);
                            if (fundDataIndex !== -1) {
                                runBacktest(fundDataIndex);
                            }
                        } else {
                            alert(`æ— æ³•è¿›è¡Œå›æµ‹${reasonMessage}ã€‚\nå¯ç”¨å›æµ‹æ—¥æœŸèŒƒå›´: ${mergedData[0].date} è‡³ ${mergedData[mergedData.length - 1].date}`);
                        }
                    }
                }
            });
        }
        
        // è®¡ç®—åˆ†ä½æ•°
        function calculatePercentile(data, percentile) {
            const sorted = [...data].sort((a, b) => a - b);
            const index = (percentile / 100) * (sorted.length - 1);
            if (Math.floor(index) === index) {
                return sorted[index];
            } else {
                const lower = sorted[Math.floor(index)];
                const upper = sorted[Math.ceil(index)];
                return lower + (upper - lower) * (index - Math.floor(index));
            }
        }
        
        // æ‰§è¡Œå›æµ‹
        function runBacktest(startDateIndex) {
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨å¹¶ç¦ç”¨ç”¨æˆ·äº¤äº’
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('backtestResults').style.display = 'none';
            document.getElementById('fundChart').style.pointerEvents = 'none';
            
            // è·å–ç”¨æˆ·è®¾ç½®çš„é˜ˆå€¼å’Œç»“æŸæ—¥æœŸ
            const buyThreshold = parseFloat(document.getElementById('buyThreshold').value) || 20;
            const sellThreshold = parseFloat(document.getElementById('sellThreshold').value) || 80;
            const customEndDate = document.getElementById('endDatePicker').value;
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿ UI æ›´æ–°
            setTimeout(function() {
                try {
                    // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
                    if (startDateIndex < 0 || startDateIndex >= fundData.length) {
                        throw new Error('æ— æ•ˆçš„èµ·å§‹æ—¥æœŸç´¢å¼•');
                    }
                    
                    // è·å–ç‚¹å‡»çš„æ—¥æœŸï¼ˆä»åŸºé‡‘æ•°æ®ä¸­è·å–ï¼‰
                    const clickedDate = fundData[startDateIndex].date;
                    
                    // åœ¨åˆå¹¶æ•°æ®ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç´¢å¼•
                    const mergedDateIndex = mergedData.findIndex(item => item.date === clickedDate);
                    
                    if (mergedDateIndex === -1) {
                        throw new Error(`æ— æ³•åœ¨åˆå¹¶æ•°æ®ä¸­æ‰¾åˆ°ç‚¹å‡»æ—¥æœŸ ${clickedDate}ã€‚è¯·æ£€æŸ¥æ•°æ®æ˜¯å¦é½å…¨ã€‚`);
                    }
                    
                    // è·å–èµ·å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ
                    const startDate = clickedDate;
                    const endDate = customEndDate || fundData[fundData.length - 1].date;
                    
                    // æ‰§è¡Œå›æµ‹é€»è¾‘
                    const backtestResult = performBacktest(mergedDateIndex, buyThreshold, sellThreshold, endDate);
                    
                    // å­˜å‚¨äº¤æ˜“è¯¦æƒ…ä¾›åç»­æŸ¥çœ‹
                    lastBacktestTradeDetails = backtestResult.tradeDetails;
                    
                    // å®šä¹‰åˆå§‹èµ„æœ¬
                    const initialCapital = 10000; // æœ¬é‡‘10000å…ƒ
                    
                    // è®¡ç®—åŸºé‡‘æ”¶ç›Šç‡
                    const finalFundValue = backtestResult.finalValue;
                    const fundReturn = ((finalFundValue - initialCapital) / initialCapital) * 100;
                    
                    // è®¡ç®—æŒ‡æ•°æ”¶ç›Šç‡
                    const startIndexFundValue = mergedData[mergedDateIndex].fundClose;
                    const customEndIndex = mergedData.findIndex(item => item.date === endDate);
                    const endIndexFundValue = customEndIndex !== -1 ? 
                        mergedData[customEndIndex].fundClose : 
                        mergedData[mergedData.length - 1].fundClose;
                    const indexShares = initialCapital / startIndexFundValue;
                    const indexFinalValue = indexShares * endIndexFundValue;
                    const indexReturn = ((indexFinalValue - initialCapital) / initialCapital) * 100;
                    
                    // è®¡ç®—è¶…é¢æ”¶ç›Š
                    const excessReturn = (fundReturn - indexReturn);
                    
                    // æ›´æ–°ç»“æœé¢æ¿
                    document.getElementById('startDate').textContent = startDate;
                    document.getElementById('endDate').textContent = endDate;
                    document.getElementById('fundReturn').textContent = fundReturn.toFixed(2) + '%';
                    document.getElementById('indexReturn').textContent = indexReturn.toFixed(2) + '%';
                    document.getElementById('excessReturn').textContent = excessReturn.toFixed(2) + '%';
                    
                    // è®¾ç½®é¢œè‰²ç±»
                    document.getElementById('fundReturn').className = 'result-value ' + (fundReturn >= 0 ? 'positive' : 'negative');
                    document.getElementById('indexReturn').className = 'result-value ' + (indexReturn >= 0 ? 'positive' : 'negative');
                    document.getElementById('excessReturn').className = 'result-value ' + (excessReturn >= 0 ? 'positive' : 'negative');
                    
                    // åœ¨åŸºé‡‘å›¾è¡¨ä¸Šæ ‡æ³¨ä¹°å–ç‚¹
                    annotateBacktestPoints(backtestResult.buyPoints, backtestResult.sellPoints);
                    
                    // éšè—åŠ è½½æŒ‡ç¤ºå™¨å¹¶æ˜¾ç¤ºç»“æœ
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('backtestResults').style.display = 'block';
                    
                    // æ¢å¤ç”¨æˆ·äº¤äº’
                    document.getElementById('fundChart').style.pointerEvents = 'auto';
                } catch (error) {
                    console.error('å›æµ‹æ‰§è¡Œå¤±è´¥:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    alert('å›æµ‹æ‰§è¡Œå¤±è´¥: ' + error.message);
                    
                    // æ¢å¤ç”¨æˆ·äº¤äº’
                    document.getElementById('fundChart').style.pointerEvents = 'auto';
                }
            }, 100);
        }
        
        // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨æœ€è¿‘ä¸€æ¬¡å›æµ‹çš„äº¤æ˜“è¯¦æƒ…
        let lastBacktestTradeDetails = [];
        
        // å®é™…æ‰§è¡Œå›æµ‹é€»è¾‘
        function performBacktest(startDateIndex, buyThreshold = 20, sellThreshold = 80, endDate = null) {
            const initialCapital = 10000; // æœ¬é‡‘10000å…ƒ
            let capital = initialCapital;
            let shares = 0;
            let lastBuyPrice = 0;
            let lastSellPrice = 0;
            let buyMode = false;
            let sellMode = false;
            let buyCount = 0; // ä¹°å…¥æ¬¡æ•°è®¡æ•°å™¨
            
            // ç¡®å®šå›æµ‹ç»“æŸæ—¥æœŸç´¢å¼•
            let endIndex = mergedData.length - 1;
            if (endDate) {
                const customEndIndex = mergedData.findIndex(item => item.date === endDate);
                console.log(`æŸ¥æ‰¾ç»“æŸæ—¥æœŸ: endDate=${endDate}, customEndIndex=${customEndIndex}`);
                if (customEndIndex !== -1) {
                    endIndex = customEndIndex;
                    console.log(`æ‰¾åˆ°ç»“æŸæ—¥æœŸç´¢å¼•: ${endIndex}, å¯¹åº”æ—¥æœŸ: ${mergedData[endIndex].date}`);
                } else {
                    // å¦‚æœæŒ‡å®šçš„æ—¥æœŸä¸å­˜åœ¨ï¼Œæ‰¾åˆ°ä¸è¶…è¿‡è¯¥æ—¥æœŸçš„æœ€åä¸€ä¸ªæ—¥æœŸ
                    const closestIndex = mergedData.findIndex(item => item.date > endDate);
                    if (closestIndex !== -1 && closestIndex > 0) {
                        endIndex = closestIndex - 1;
                        console.log(`æŒ‡å®šæ—¥æœŸä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ€è¿‘çš„æ—¥æœŸç´¢å¼•: ${endIndex}, å¯¹åº”æ—¥æœŸ: ${mergedData[endIndex].date}`);
                    } else if (closestIndex === -1) {
                        // æ‰€æœ‰æ•°æ®éƒ½ä¸è¶…è¿‡æŒ‡å®šæ—¥æœŸï¼Œä½¿ç”¨æœ€åä¸€ä¸ªæ•°æ®
                        endIndex = mergedData.length - 1;
                        console.log(`æŒ‡å®šæ—¥æœŸä¹‹åæ— æ•°æ®ï¼Œä½¿ç”¨æœ€åæ—¥æœŸç´¢å¼•: ${endIndex}, å¯¹åº”æ—¥æœŸ: ${mergedData[endIndex].date}`);
                    }
                }
            }
            console.log(`æœ€ç»ˆå›æµ‹èŒƒå›´: ä»ç´¢å¼• ${startDateIndex}(${mergedData[startDateIndex].date}) åˆ° ${endIndex}(${mergedData[endIndex].date})`);
            
            // å­˜å‚¨ä¹°å–ç‚¹å’Œäº¤æ˜“è¯¦æƒ…
            const buyPoints = [];
            const sellPoints = [];
            const tradeDetails = []; // å­˜å‚¨äº¤æ˜“è¯¦æƒ…
            
            // ä½¿ç”¨é¢„è®¡ç®—çš„PEåˆ†ä½ç‚¹
            const pePercentiles = mergedData.map(d => d.percentile);
            
            // è®°å½•èµ·å§‹æ•°æ®ç”¨äºæ”¶ç›Šç‡è®¡ç®—
            const startFundValue = mergedData[startDateIndex].fundClose;
            
            console.log(`å¼€å§‹å›æµ‹: èµ·å§‹æ—¥æœŸç´¢å¼•=${startDateIndex}, èµ·å§‹æ—¥æœŸ=${mergedData[startDateIndex].date}, ä¹°å…¥é˜ˆå€¼=${buyThreshold}%, å–å‡ºé˜ˆå€¼=${sellThreshold}%`);
            console.log(`èµ·å§‹æ•°æ®: åŸºé‡‘å‡€å€¼=${startFundValue.toFixed(4)}`);
            tradeDetails.push({
                type: 'å¼€å§‹',
                date: mergedData[startDateIndex].date,
                price: '-',
                shares: shares,
                capital: capital.toFixed(2),
                description: `å¼€å§‹å›æµ‹ï¼Œåˆå§‹èµ„é‡‘: ${initialCapital.toFixed(2)}å…ƒï¼Œä¹°å…¥é˜ˆå€¼: ${buyThreshold}%ï¼Œå–å‡ºé˜ˆå€¼: ${sellThreshold}%`
            });
            
            // æ¯ä»½é‡‘é¢ä¸º1000å…ƒï¼ˆæ€»æœ¬é‡‘çš„1/10ï¼‰
            const capitalPerShare = 1000;
            
            // ä»èµ·å§‹æ—¥æœŸå¼€å§‹å›æµ‹ï¼Œç›´åˆ°æŒ‡å®šçš„ç»“æŸæ—¥æœŸ
            for (let i = startDateIndex; i <= endIndex; i++) {
                const dayData = mergedData[i];
                const fundValue = dayData.fundClose; // ä½¿ç”¨æ­£ç¡®çš„åŸºé‡‘å‡€å€¼æ•°æ®
                const pePercentile = pePercentiles[i]; // ä½¿ç”¨é¢„è®¡ç®—çš„PEåˆ†ä½ç‚¹
                
                // è®¡ç®—å½“å‰åŸºé‡‘çš„ç´¯è®¡æ”¶ç›Šç‡
                const currentFundReturn = ((fundValue - startFundValue) / startFundValue) * 100;
                
                // æ£€æŸ¥æ˜¯å¦è¿›å…¥ä¹°å…¥æ¨¡å¼ (PEåˆ†ä½ç‚¹å‘ä¸‹ç©¿è¶ŠbuyThreshold%)
                if (pePercentile && pePercentile < buyThreshold && !buyMode) {
                    buyMode = true;
                    sellMode = false;
                    console.log(`ä¹°å…¥æ¨¡å¼å¼€å¯: æ—¥æœŸ=${dayData.date}, PEåˆ†ä½ç‚¹=${pePercentile.toFixed(2)}%`);
                    console.log(`  å½“å‰æ”¶ç›Šç‡: åŸºé‡‘=${currentFundReturn.toFixed(2)}%`);
                    tradeDetails.push({
                        type: 'æ¨¡å¼åˆ‡æ¢',
                        date: dayData.date,
                        price: '-',
                        shares: shares,
                        capital: capital.toFixed(2),
                        description: `ä¹°å…¥æ¨¡å¼å¼€å¯ï¼ŒPEåˆ†ä½ç‚¹: ${pePercentile.toFixed(2)}%ï¼Œé˜ˆå€¼: ${buyThreshold}%`
                    });
                    
                    // åˆå§‹ä¹°å…¥1ä»½ï¼ˆæ ¹æ®åŸºé‡‘å‡€å€¼è®¡ç®—ï¼‰
                    if (capital >= fundValue) {
                        const shareAmount = Math.min(Math.floor(capitalPerShare / fundValue), Math.floor(capital / fundValue));
                        if (shareAmount > 0) {
                            capital -= shareAmount * fundValue;
                            shares += shareAmount;
                            lastBuyPrice = fundValue;
                            buyCount = 1; // è®°å½•ä¹°å…¥æ¬¡æ•°
                            buyPoints.push({
                                date: dayData.date,
                                price: fundValue,
                                shares: shares
                            });
                            console.log(`åˆå§‹ä¹°å…¥: æ—¥æœŸ=${dayData.date}, ä»·æ ¼=${fundValue.toFixed(4)}, ä»½é¢=${shares}, å‰©ä½™èµ„é‡‘=${capital.toFixed(2)}`);
                            tradeDetails.push({
                                type: 'ä¹°å…¥',
                                date: dayData.date,
                                price: fundValue.toFixed(4),
                                shares: shareAmount,
                                amount: (shareAmount * fundValue).toFixed(2),
                                capital: capital.toFixed(2),
                                description: `åˆå§‹ä¹°å…¥${shareAmount}ä»½ï¼Œä»·æ ¼: ${fundValue.toFixed(4)}`
                            });
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦è¿›å…¥å–å‡ºæ¨¡å¼ (PEåˆ†ä½ç‚¹å‘ä¸Šç©¿è¶ŠsellThreshold%)
                if (pePercentile && pePercentile > sellThreshold && !sellMode) {
                    sellMode = true;
                    buyMode = false;
                    lastSellPrice = fundValue; // è¿›å…¥å–å‡ºæ¨¡å¼æ—¶è®¾ç½®åŸºå‡†ä»·æ ¼
                    
                    console.log(`å–å‡ºæ¨¡å¼å¼€å¯: æ—¥æœŸ=${dayData.date}, PEåˆ†ä½ç‚¹=${pePercentile.toFixed(2)}%`);
                    tradeDetails.push({
                        type: 'æ¨¡å¼åˆ‡æ¢',
                        date: dayData.date,
                        price: '-',
                        shares: shares,
                        capital: capital.toFixed(2),
                        description: `å–å‡ºæ¨¡å¼å¼€å¯ï¼ŒPEåˆ†ä½ç‚¹: ${pePercentile.toFixed(2)}%ï¼Œé˜ˆå€¼: ${sellThreshold}%ï¼ŒåŸºå‡†å–ä»·: ${fundValue.toFixed(4)}`
                    });
                    
                    // ç«‹å³è¿›è¡Œç¬¬ä¸€æ¬¡å–å‡º
                    if (shares > 0) {
                        const sellShareAmount = Math.max(Math.floor(shares * 0.1), 1);
                        if (sellShareAmount > 0) {
                            capital += sellShareAmount * fundValue;
                            shares -= sellShareAmount;
                            
                            sellPoints.push({
                                date: dayData.date,
                                price: fundValue,
                                shares: shares
                            });
                            
                            console.log(`åˆå§‹å–å‡º: æ—¥æœŸ=${dayData.date}, ä»·æ ¼=${fundValue.toFixed(4)}, ä»½é¢=${sellShareAmount}, å‰©ä½™ä»½é¢=${shares}`);
                            tradeDetails.push({
                                type: 'å–å‡º',
                                date: dayData.date,
                                price: fundValue.toFixed(4),
                                shares: sellShareAmount,
                                amount: (sellShareAmount * fundValue).toFixed(2),
                                capital: capital.toFixed(2),
                                description: `è¿›å…¥å–å‡ºæ¨¡å¼ï¼Œåˆå§‹å–å‡º${sellShareAmount}ä»½ï¼Œä»·æ ¼: ${fundValue.toFixed(4)}`
                            });
                        }
                    }
                }
                
                // ä¹°å…¥æ¨¡å¼ï¼šæ¯è·Œ4%ä¹°å…¥1ä»½ï¼Œæœ€å¤š10ä»½
                if (buyMode && buyCount < 10 && lastBuyPrice > 0) {
                    const dropRatio = (lastBuyPrice - fundValue) / lastBuyPrice;
                    
                    if (dropRatio >= 0.04 && capital >= fundValue) {
                        const shareAmount = Math.min(Math.floor(capitalPerShare / fundValue), Math.floor(capital / fundValue));
                        
                        if (shareAmount > 0) {
                            capital -= shareAmount * fundValue;
                            shares += shareAmount;
                            lastBuyPrice = fundValue;
                            buyCount++;
                            buyPoints.push({
                                date: dayData.date,
                                price: fundValue,
                                shares: shares
                            });
                            
                            console.log(`è¡¥ä»“ä¹°å…¥: æ—¥æœŸ=${dayData.date}, ä»·æ ¼=${fundValue.toFixed(4)}, ä»½é¢=${shares}, è·Œå¹…=${(dropRatio * 100).toFixed(2)}%, å‰©ä½™èµ„é‡‘=${capital.toFixed(2)}`);
                            tradeDetails.push({
                                type: 'ä¹°å…¥',
                                date: dayData.date,
                                price: fundValue.toFixed(4),
                                shares: shareAmount,
                                amount: (shareAmount * fundValue).toFixed(2),
                                capital: capital.toFixed(2),
                                description: `è¡¥ä»“ä¹°å…¥${shareAmount}ä»½ï¼Œä»·æ ¼: ${fundValue.toFixed(4)}ï¼Œè·Œå¹…: ${(dropRatio * 100).toFixed(2)}%`
                            });
                        }
                    }
                }
                
                // å–å‡ºæ¨¡å¼ï¼šæ¯æ¶¨4%å–å‡ºä¸€ä»½ï¼Œæœ€å¤š10ä»½
                if (sellMode && shares > 0) {
                    const riseRatio = (fundValue - lastSellPrice) / lastSellPrice;
                    
                    if (riseRatio >= 0.04) {
                        const sellShareAmount = Math.max(Math.floor(shares * 0.1), 1);
                        if (sellShareAmount > 0) {
                            capital += sellShareAmount * fundValue;
                            shares -= sellShareAmount;
                            lastSellPrice = fundValue;
                            
                            sellPoints.push({
                                date: dayData.date,
                                price: fundValue,
                                shares: shares
                            });
                            
                            console.log(`å–å‡º: æ—¥æœŸ=${dayData.date}, ä»·æ ¼=${fundValue.toFixed(4)}, ä»½é¢=${sellShareAmount}, æ¶¨å¹…=${(riseRatio * 100).toFixed(2)}%, å‰©ä½™ä»½é¢=${shares}`);
                            tradeDetails.push({
                                type: 'å–å‡º',
                                date: dayData.date,
                                price: fundValue.toFixed(4),
                                shares: sellShareAmount,
                                amount: (sellShareAmount * fundValue).toFixed(2),
                                capital: capital.toFixed(2),
                                description: `å–å‡º${sellShareAmount}ä»½ï¼Œä»·æ ¼: ${fundValue.toFixed(4)}ï¼Œæ¶¨å¹…: ${(riseRatio * 100).toFixed(2)}%`
                            });
                        }
                    }
                }
            }
            
            // è®¡ç®—æœ€ç»ˆä»·å€¼
            const finalFundValue = mergedData[endIndex].fundClose;
            const finalValue = capital + shares * finalFundValue;
            const totalReturn = ((finalValue - initialCapital) / initialCapital) * 100;
            
            console.log(`å›æµ‹ç»“æŸ: æœ€ç»ˆä»·å€¼=${finalValue.toFixed(2)}, æ€»æ”¶ç›Šç‡=${totalReturn.toFixed(2)}%, æŒæœ‰ä»½é¢=${shares}, å‰©ä½™èµ„é‡‘=${capital.toFixed(2)}`);
            
            tradeDetails.push({
                type: 'ç»“æŸ',
                date: mergedData[endIndex].date,
                price: '-',
                shares: shares,
                capital: capital.toFixed(2),
                description: `å›æµ‹ç»“æŸï¼Œæœ€ç»ˆä»·å€¼: ${finalValue.toFixed(2)}å…ƒ`
            });
            
            return {
                buyPoints,
                sellPoints,
                finalShares: shares,
                finalValue: finalValue,
                totalReturn: totalReturn,
                tradeDetails: tradeDetails
            };
        }
        
        // åœ¨åŸºé‡‘å›¾è¡¨ä¸Šæ ‡æ³¨ä¹°å–ç‚¹
        function annotateBacktestPoints(buyPoints, sellPoints) {
            // ç§»é™¤ä¹‹å‰æ·»åŠ çš„æ³¨é‡Š
            const fundChartElement = document.getElementById('fundChart');
            const existingAnnotations = fundChartElement.data.filter(trace => 
                trace.name === 'ä¹°å…¥ç‚¹' || trace.name === 'å–å‡ºç‚¹'
            );
            
            if (existingAnnotations.length > 0) {
                Plotly.deleteTraces(fundChartElement, 
                    fundChartElement.data.map((trace, index) => index).filter(index => 
                        fundChartElement.data[index].name === 'ä¹°å…¥ç‚¹' || 
                        fundChartElement.data[index].name === 'å–å‡ºç‚¹'
                    )
                );
            }
            
            // åˆå¹¶å¹¶æ’åºæ‰€æœ‰äº¤æ˜“ç‚¹
            const allPoints = [...buyPoints.map(p => ({...p, type: 'ä¹°å…¥'})), 
                              ...sellPoints.map(p => ({...p, type: 'å–å‡º'}))]
                              .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // æ·»åŠ ä¹°å…¥ç‚¹æ ‡è®°
            if (buyPoints.length > 0) {
                const buyTrace = {
                    x: buyPoints.map(point => point.date),
                    y: buyPoints.map(point => point.price),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'ä¹°å…¥ç‚¹',
                    marker: { 
                        color: '#2ca02c',
                        size: 10,
                        symbol: 'triangle-up'
                    },
                    text: buyPoints.map((point, index) => {
                        // æŸ¥æ‰¾ä¸Šæ¬¡äº¤æ˜“ç‚¹
                        const prevPoint = findPreviousPoint(allPoints, point.date);
                        let changeInfo = '';
                        if (prevPoint) {
                            const changeRatio = ((point.price - prevPoint.price) / prevPoint.price) * 100;
                            changeInfo = `<br>ç›¸å¯¹ä¸Šæ¬¡${prevPoint.type}: ${changeRatio.toFixed(2)}%`;
                        }
                        return `ä¹°å…¥<br>æ—¶é—´: ${point.date}<br>ä»·æ ¼: ${point.price.toFixed(4)}<br>ä»½é¢: ${point.shares}${changeInfo}`;
                    }),
                    hovertemplate: '%{text}<extra></extra>'
                };
                
                Plotly.addTraces(fundChartElement, buyTrace);
            }
            
            // æ·»åŠ å–å‡ºç‚¹æ ‡è®°
            if (sellPoints.length > 0) {
                const sellTrace = {
                    x: sellPoints.map(point => point.date),
                    y: sellPoints.map(point => point.price),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'å–å‡ºç‚¹',
                    marker: { 
                        color: '#d62728',
                        size: 10,
                        symbol: 'triangle-down'
                    },
                    text: sellPoints.map((point, index) => {
                        // æŸ¥æ‰¾ä¸Šæ¬¡äº¤æ˜“ç‚¹
                        const prevPoint = findPreviousPoint(allPoints, point.date);
                        let changeInfo = '';
                        if (prevPoint) {
                            const changeRatio = ((point.price - prevPoint.price) / prevPoint.price) * 100;
                            changeInfo = `<br>ç›¸å¯¹ä¸Šæ¬¡${prevPoint.type}: ${changeRatio.toFixed(2)}%`;
                        }
                        return `å–å‡º<br>æ—¶é—´: ${point.date}<br>ä»·æ ¼: ${point.price.toFixed(4)}<br>ä»½é¢: ${point.shares}${changeInfo}`;
                    }),
                    hovertemplate: '%{text}<extra></extra>'
                };
                
                Plotly.addTraces(fundChartElement, sellTrace);
            }
        }
        
        // æŸ¥æ‰¾æŒ‡å®šæ—¥æœŸä¹‹å‰çš„æœ€åä¸€ä¸ªäº¤æ˜“ç‚¹
        function findPreviousPoint(allPoints, currentDate) {
            const currentDateTime = new Date(currentDate).getTime();
            // è¿‡æ»¤å‡ºæ—©äºå½“å‰æ—¥æœŸçš„äº¤æ˜“ç‚¹
            const earlierPoints = allPoints.filter(point => 
                new Date(point.date).getTime() < currentDateTime
            );
            
            // è¿”å›æœ€æ¥è¿‘å½“å‰æ—¥æœŸçš„äº¤æ˜“ç‚¹
            if (earlierPoints.length > 0) {
                return earlierPoints[earlierPoints.length - 1];
            }
            return null;
        }
        
        // éšè—å›æµ‹ç»“æœ
        function hideBacktestResults() {
            document.getElementById('backtestResults').style.display = 'none';
            
            // ç§»é™¤ä¹°å–ç‚¹æ ‡è®°
            const fundChartElement = document.getElementById('fundChart');
            const annotationIndices = [];
            
            // æŸ¥æ‰¾éœ€è¦åˆ é™¤çš„è¿¹çº¿ç´¢å¼•
            for (let i = 0; i < fundChartElement.data.length; i++) {
                if (fundChartElement.data[i].name === 'ä¹°å…¥ç‚¹' || 
                    fundChartElement.data[i].name === 'å–å‡ºç‚¹') {
                    annotationIndices.push(i);
                }
            }
            
            // é€†åºåˆ é™¤ï¼ˆé¿å…ç´¢å¼•å˜åŒ–å½±å“ï¼‰
            annotationIndices.reverse().forEach(index => {
                Plotly.deleteTraces(fundChartElement, index);
            });
        }
        
        // æ˜¾ç¤ºäº¤æ˜“è¯¦æƒ…
        function showTradeDetails() {
            const modal = document.getElementById('tradeDetailsModal');
            const content = document.getElementById('tradeDetailsContent');
            
            // åˆ›å»ºè¡¨æ ¼å±•ç¤ºäº¤æ˜“è¯¦æƒ…
            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ç±»å‹</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">æ—¥æœŸ</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ä»·æ ¼</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ä»½é¢</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">èŠ±è´¹é‡‘é¢</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">å‰©ä½™èµ„é‡‘</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">æè¿°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            lastBacktestTradeDetails.forEach(detail => {
                tableHtml += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.type}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.date}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.price}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.shares}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.amount || '-'}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.capital}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${detail.description}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            content.innerHTML = tableHtml;
            modal.style.display = 'block';
        }
        
        // å…³é—­äº¤æ˜“è¯¦æƒ…
        function closeTradeDetails() {
            const modal = document.getElementById('tradeDetailsModal');
            modal.style.display = 'none';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­æ¨¡æ€æ¡†
        window.onclick = function(event) {
            const modal = document.getElementById('tradeDetailsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>